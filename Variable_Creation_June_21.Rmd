---
title: "Variable_Creation_June_21"
author: "Yasu and yuru"
date: '2023-06-21'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

##Library Import
```{r}
library(data.table)
library(tidyr)
library(tidyverse)
library(rollRegres)
library(roll)
library(zoo)
library(math)
```

```{r}
load("~/Desktop/Summer Semester/Advanced Seminar/GBR/panel_country_May28.RData")
load("~/Desktop/Summer Semester/Advanced Seminar/GBR/DTB6_monthly.RData")
panel_country <- as.data.table(panel_country)
```

##Create regression data
###Coefficients
```{r}
#merging panel_country with DTB6_monthly(risk free rate) 
panel_reduced <- merge(panel_country[!is.na(RET.USD) & !is.na(MV.USD) & !is.infinite(RET.USD) & !is.infinite(MV.USD), c("Id", "ym", "RET.USD", "MV.USD")], DTB6_monthly[,c("ym", "DTB6")], by=c("ym"))
```

```{r}
panel_reduced[, MRET.USD:=weighted.mean(RET.USD, coalesce(MV.USD, 0), na.rm = T), by=ym]
panel_reduced[, RE.USD:=RET.USD-DTB6]
panel_reduced[, REM.USD:=MRET.USD-DTB6]
panel_reduced <- setorderv(panel_reduced, c("ym"))
```

```{r}
coef.fun <- . %>% as.data.frame %>% lm %>% .$coefficients
```

#### 1-Year

```{r}
coef_12 <- panel_reduced %>%
  group_by(Id) %>%
  do(cbind(
           select(., ym, RET.USD),
           coef = select(., RE.USD, REM.USD) %>%
             rollapplyr(12, coef.fun, by.column = FALSE, fill = NA)
           )) %>%
  ungroup
```
####3-Year
```{r}
coef_36 <- panel_reduced %>%
  group_by(Id) %>%
  do(cbind(
           select(., ym, RET.USD),
           coef = select(., RE.USD, REM.USD) %>%
             rollapplyr(36, coef.fun, by.column = FALSE, fill = NA)
           )) %>%
  ungroup
```

#### 5-Year

```{r}
coef_60 <- panel_reduced %>%
  group_by(Id) %>%
  do(cbind(
           select(., ym, RET.USD),
           coef = select(., RE.USD, REM.USD) %>%
             rollapplyr(60, coef.fun, by.column = FALSE, fill = NA)
           )) %>%
  ungroup
```

###Sigma

```{r}
resid.fun <- . %>% as.data.frame %>% lm %>% .$residuals
```

#### 1-Year

```{r}
resid_12 <- panel_reduced %>%
  group_by(Id) %>%
  do(cbind(
           select(., ym, RET.USD),
           resid = select(., RE.USD, REM.USD) %>%
             rollapplyr(12, resid.fun, by.column = FALSE, fill = NA)
           )) %>%
  ungroup
```

#### 3-Year

```{r}
resid_36 <- panel_reduced %>%
  group_by(Id) %>%
  do(cbind(
           select(., ym, RET.USD),
           resid = select(., RE.USD, REM.USD) %>%
             rollapplyr(36, resid.fun, by.column = FALSE, fill = NA)
           )) %>%
  ungroup
```


#### 5-Year

```{r}
resid_60 <- panel_reduced %>%
  group_by(Id) %>%
  do(cbind(
           select(., ym, RET.USD),
           resid = select(., RE.USD, REM.USD) %>%
             rollapplyr(60, resid.fun, by.column = FALSE, fill = NA)
           )) %>%
  ungroup
```

###Monthly Standard Deviation
```{r}
roll.sd.data <- panel_reduced %>%
  group_by(Id)%>%
  mutate(SD.RET.USD=rollapply(RET.USD,12,sd,align='right',fill=NA)) %>%
  ungroup
```


##Factors
###Value
####B/M
```{r}
# Select only necessary variables from the comprehensive data set
panel_reduced_val<- panel_country[!is.na(RET.USD),c("Id","ym","MV.USD","RET.USD","WC05476", "WC05001", "WC05202", "WC18100", "WC18198")]

# Find the length of history of each stock, and filter out stocks that has a history less than 12 months
count_table <- panel_reduced_val[,.N,by=Id]
panel_reduced_val <- panel_reduced_val[count_table[N>12]$Id]

#WC05001 Market Price, WC05476 Book Value per Share
#WC05001 Market Price, WC05202 Earnings per Share - Fiscal Year End
#WC18100 Enterprise value, WC18198 Earnings before Interest, Taxes, Depreciation & Amortization (EBITDA)

panel_reduced_val <- panel_reduced_val[,`B/M` := WC05476/WC05001]
panel_reduced_val <- panel_reduced_val[,`E/P` := WC05202/WC05001]
panel_reduced_val <- panel_reduced_val[,`EBITDA/EV` := WC18198/WC18100]

panel_reduced_val <- panel_reduced_val %>% 
  select(Id, ym, MV.USD, RET.USD, `B/M`, `E/P`, `EBITDA/EV`)

```

####E/P
####EBITDA/EV



###Size
####Log_MV
```{r}
# Select only necessary variables from the comprehensive data set
panel_reduced_lnMV<- panel_country[!is.na(RET.USD),c("Id","ym","MV.USD","RET.USD")]

# Find the length of history of each stock, and filter out stocks that has a history less than 12 months
count_table <- panel_reduced_lnMV[,.N,by=Id]
panel_reduced_lnMV <- panel_reduced_lnMV[count_table[N>12]$Id]

#WC05001 Market Price, WC05476 Book Value per Share
panel_reduced_lnMV <- panel_reduced_lnMV[, Log_MV := log(MV.USD)]

panel_reduced_lnMV <- panel_reduced_lnMV %>% 
  select(Id, ym, MV.USD, RET.USD, Log_MV)
```


###Momentum
####RSI
```{r}
# Select only necessary variables from the comprehensive data set
panel_reduced_rsi <- panel_country[!is.na(RET.USD),c("Id","ym","MV.USD","RET.USD")]

# Find the length of history of each stock, and filter out stocks that has a history less than 12 months
count_table <- panel_reduced_rsi[,.N,by=Id]
panel_reduced_rsi <- panel_reduced_rsi[count_table[N>12]$Id]


panel_reduced_rsi[, gain := ifelse(RET.USD>0, RET.USD, 0)]
panel_reduced_rsi[, loss := ifelse(RET.USD<0, -RET.USD, 0)]

panel_reduced_rsi[, average_gain := frollmean(gain, 12, align = "right"), by = Id]
panel_reduced_rsi[, average_loss := frollmean(loss, 12, align = "right"), by = Id]
panel_reduced_rsi[, RS := average_gain/average_loss]
panel_reduced_rsi[, RSI := 100 - (100/(1+RS))]
```

####Alpha_1
```{r}
# Select only necessary variables from the comprehensive data set
panel_reduced_alpha <- panel_country[!is.na(RET.USD),c("Id","ym","MV.USD","RET.USD")]

# Find the length of history of each stock, and filter out stocks that has a history less than 12 months
count_table <- panel_reduced_alpha[,.N,by=Id]
panel_reduced_alpha <- panel_reduced_alpha[count_table[N>12]$Id]

panel_reduced_alpha <- panel_reduced_alpha %>%
  select(Id, ym, MV.USD) %>% 
  full_join(coef_12, by = c("Id", "ym"))

names(panel_reduced_alpha) <- c("Id", "ym", "MV.USD", "RET.USD", "alpha", "beta", "coef")

panel_reduced_alpha <- panel_reduced_alpha %>%
  select(Id, ym, MV.USD, RET.USD, alpha)
```
####Alpha_3
####Alpha_5
####Momentum_12_2
```{r}
# Select only necessary variables from the comprehensive data set
panel_reduced_momentum <- panel_country[!is.na(RET.USD),c("Id","ym","MV.USD","RET.USD")]

# Find the length of history of each stock, and filter out stocks that has a history less than 12 months
count_table <- panel_reduced_momentum[,.N,by=Id]
panel_reduced_momentum <- panel_reduced_momentum[count_table[N>12]$Id]

# Define a function to find the lagged value of return for a stock
create_lag <- function(x, n) c(rep(NA, n), head(x, -n))

# Using the function to find the 12-months-ago, 11-months-ago, ~, 3 months ago return of stock 
panel_reduced_momentum[, Before2 := create_lag(RET.USD, 2), by = Id]
panel_reduced_momentum[, Before3 := create_lag(RET.USD, 3), by = Id]
panel_reduced_momentum[, Before4 := create_lag(RET.USD, 4), by = Id]
panel_reduced_momentum[, Before5 := create_lag(RET.USD, 5), by = Id]
panel_reduced_momentum[, Before6 := create_lag(RET.USD, 6), by = Id]
panel_reduced_momentum[, Before7 := create_lag(RET.USD, 7), by = Id]
panel_reduced_momentum[, Before8 := create_lag(RET.USD, 8), by = Id]
panel_reduced_momentum[, Before9 := create_lag(RET.USD, 9), by = Id]
panel_reduced_momentum[, Before10 := create_lag(RET.USD, 10), by = Id]
panel_reduced_momentum[, Before11 := create_lag(RET.USD, 11), by = Id]
panel_reduced_momentum[, Before12 := create_lag(RET.USD, 12), by = Id]

# Momentum_12_2: Past performance of stocks: use geometric mean to calculate the compound return of a stock over the past twelve months, but ignores the previous month
panel_reduced_momentum <- panel_reduced_momentum[,Momentum_12_2:=((100+Before2)*(100+Before3)*(100+Before4)*(100+Before5)*(100+Before6)*(100+Before7)*(100+Before8)*(100+Before9)*(100+Before10)*(100+Before11)*(100+Before12))^(1/10)-100]

```
###Yield
####DY
###Quality
####ROE
```{r}
#Select only necessary variables from the comprehensive data set 
panel_reduced_ROE <- panel_country[!is.na(RET.USD),c("Id","ym","MV.USD","RET.USD","WC08301")]

# Find the length of history of each stock, and filter out stocks that has a history less than 12 months

count_table <- panel_reduced_ROE[,.N,by=Id]
panel_reduced_ROE <- panel_reduced_ROE[count_table[N>12]$Id]

#WC08301 Return on Equity -- Total (%)
panel_reduced_ROE <- panel_reduced_ROE[,ROE:=WC08301] 

panel_reduced_ROE <- panel_reduced_ROE %>% select(Id, ym, MV.USD, RET.USD, ROE)

```
####ROA

###Low Volatility
####Beta_1
####Beta_3
####Beta_5
####Sigma_1
####Sigma_3
####Sigma_5
####SD

###liqidity
####T/O
###Growth
####EPS
####SPS

###Others
####MV
```{r}
# Select only necessary variables from the comprehensive data set
panel_reduced_MV<- panel_country[!is.na(RET.USD),c("Id","ym","MV.USD","RET.USD")]

# Find the length of history of each stock, and filter out stocks that has a history less than 12 months
count_table <- panel_reduced_MV[,.N,by=Id]
panel_reduced_MV <- panel_reduced_MV[count_table[N>12]$Id]
```

####AG
```{r}
# Select only necessary variables from the comprehensive data set
panel_reduced_inv<- panel_country[!is.na(RET.USD),c("Id","ym","MV.USD","RET.USD","WC02999")]

# Find the length of history of each stock, and filter out stocks that has a history less than 12 months
count_table <- panel_reduced_inv[,.N,by=Id]
panel_reduced_inv <- panel_reduced_inv[count_table[N>12]$Id]

#WC02999 Total Assets
panel_reduced_inv <- panel_reduced_inv %>% 
  mutate(Lagged_Asset = shift(WC02999, n = 12)) %>%
  mutate(AG = (WC02999 - Lagged_Asset) / Lagged_Asset *100) %>% 
  select(-Lagged_Asset)

panel_reduced_inv <- panel_reduced_inv %>% 
  select(Id, ym, MV.USD, RET.USD, AG)
```


##Facotr Data FF5
```{r}
##Factor data for FF5
names(coef_36) <-  c("Id", "ym", "RET.USD", "alpha_36", "beta_36", "coef_36")

Factor_data_ff5 <- coef_36 %>% 
  select(Id, ym, beta_36) %>%
  full_join(panel_reduced_val, by = c("Id", "ym")) %>% 
  select(Id, ym, MV.USD, RET.USD, beta_36, `B/M`) %>% 
  full_join(panel_reduced_ROE, by = c("Id", "ym", "MV.USD", "RET.USD")) %>% 
  select(Id, ym, MV.USD, RET.USD, beta_36, `B/M`, ROE) %>% 
  full_join(panel_reduced_inv, by = c("Id", "ym", "MV.USD", "RET.USD")) %>%
  select(Id, ym, MV.USD, RET.USD, beta_36, `B/M`, ROE, AG) %>% 
  full_join(panel_reduced_momentum, by = c("Id", "ym", "MV.USD", "RET.USD")) %>% 
  select(Id, ym, RET.USD, beta_36, MV.USD, `B/M`, ROE, AG, Momentum_12_2)

names(Factor_data_ff5) <- c("Id", "ym", "RET.USD", "Beta_3", "MV", "`B/M`", "ROE", "AG", "Mom_12_2")
```

```{r}
save(Factor_data_ff5, file = "/Users/kojimadamsimith/Desktop/Summer Semester/Advanced Seminar/GBR/Factor_data_FF5.RData")
```  
  
  
##Factor data
```{r}
names(coef_12) <-  c("Id", "ym", "RET.USD", "alpha_12", "beta_12", "coef_12")

names(coef_36) <-  c("Id", "ym", "RET.USD", "alpha_36", "beta_36", "coef_36")

names(coef_60) <-  c("Id", "ym", "RET.USD", "alpha_60", "beta_60", "coef_60")

resid_12_r <- resid_12 %>% 
  select(Id, ym, RET.USD, resid.12)

resid_36_r <- resid_36 %>% 
  select(Id, ym, RET.USD, resid.36)

resid_60_r <- resid_60 %>% 
  select(Id, ym, RET.USD, resid.60)

Factor_data <- panel_reduced_val %>% 
  select(Id, ym, MV.USD, RET.USD, BTM) %>% 
  full_join(panel_reduced_SMB, by = c("Id", "ym")) %>% 
  select(Id, ym, MV.USD, RET.USD, BTM, MV) %>% 
  full_join(panel_reduced_momentum, by = c("Id", "ym", "MV.USD", "RET.USD")) %>% 
  select(Id, ym, MV.USD, RET.USD, BTM, MV, Momentum_12_2) %>% 
  full_join(panel_reduced_rsi, by = c("Id", "ym", "MV.USD", "RET.USD")) %>%
  select(Id, ym, MV.USD, RET.USD, BTM, MV, Momentum_12_2, RSI) %>%
  full_join(coef_12, by = c("Id", "ym", "RET.USD")) %>% 
  select(Id, ym, MV.USD, RET.USD, BTM, MV, Momentum_12_2, RSI, alpha_12, beta_12) %>% full_join(coef_36, by = c("Id", "ym", "RET.USD")) %>% 
  select(Id, ym, MV.USD, RET.USD, BTM, MV, Momentum_12_2, RSI, alpha_12, beta_12, alpha_36, beta_36) %>% 
  full_join(coef_60, by = c("Id", "ym", "RET.USD")) %>% 
  select(Id, ym, MV.USD, RET.USD, BTM, MV, Momentum_12_2, RSI, alpha_12, beta_12, alpha_36, beta_36, alpha_60, beta_60) %>% 
  full_join(panel_reduced_yield ,by = c("Id", "ym", "MV.USD", "RET.USD")) %>% 
  select(Id, ym, MV.USD, RET.USD, BTM, MV, Momentum_12_2, RSI, alpha_12, beta_12, alpha_36, beta_36, alpha_60, beta_60, DY) %>% 
  full_join(panel_reduced_prof ,by = c("Id", "ym", "MV.USD", "RET.USD")) %>% 
  select(Id, ym, MV.USD, RET.USD, BTM, MV, Momentum_12_2, RSI, alpha_12, beta_12, alpha_36, beta_36, alpha_60, beta_60, DY, ROE) %>% 
  full_join(panel_reduced_inv ,by = c("Id", "ym", "MV.USD", "RET.USD")) %>% 
  select(Id, ym, MV.USD, RET.USD, BTM, MV, Momentum_12_2, RSI, alpha_12, beta_12, alpha_36, beta_36, alpha_60, beta_60, DY, ROE, Change_Asset) %>% 
  full_join(panel_reduced_eps ,by = c("Id", "ym", "MV.USD", "RET.USD")) %>% 
  select(Id, ym, MV.USD, RET.USD, BTM, MV, Momentum_12_2, RSI, alpha_12, beta_12, alpha_36, beta_36, alpha_60, beta_60, DY, ROE, Change_Asset, Growth_Rate_EPS) %>% 
  full_join(panel_reduced_sps ,by = c("Id", "ym", "MV.USD", "RET.USD")) %>% 
  select(Id, ym, MV.USD, RET.USD, BTM, MV, Momentum_12_2, RSI, alpha_12, beta_12, alpha_36, beta_36, alpha_60, beta_60, DY, ROE, Change_Asset, Growth_Rate_EPS, Growth_Rate_SPS) %>% 
  full_join(resid_12_r, by = c("Id", "ym", "RET.USD")) %>% 
  select(Id, ym, MV.USD, RET.USD, BTM, MV, Momentum_12_2, RSI, alpha_12, beta_12, alpha_36, beta_36, alpha_60, beta_60, DY, ROE, Change_Asset, Growth_Rate_EPS, Growth_Rate_SPS, resid.12) %>% 
  full_join(resid_36_r, by = c("Id", "ym", "RET.USD")) %>% 
  select(Id, ym, MV.USD, RET.USD, BTM, MV, Momentum_12_2, RSI, alpha_12, beta_12, alpha_36, beta_36, alpha_60, beta_60, DY, ROE, Change_Asset, Growth_Rate_EPS, Growth_Rate_SPS, resid.12, resid.36) %>% 
  full_join(resid_60_r, by = c("Id", "ym", "RET.USD")) %>% 
  select(Id, ym, MV.USD, RET.USD, BTM, MV, Momentum_12_2, RSI, alpha_12, beta_12, alpha_36, beta_36, alpha_60, beta_60, DY, ROE, Change_Asset, Growth_Rate_EPS, Growth_Rate_SPS, resid.12, resid.36, resid.60) %>% 
  full_join(roll.sd.data ,by = c("Id", "ym", "MV.USD", "RET.USD")) %>% 
  select(Id, ym, MV.USD, RET.USD, BTM, MV, Momentum_12_2, RSI, alpha_12, beta_12, alpha_36, beta_36, alpha_60, beta_60, DY, ROE, Change_Asset, Growth_Rate_EPS, Growth_Rate_SPS, resid.12, resid.36, resid.60, SD.RET.USD)
  
write.csv(Factor_data, "/Users/kojimadamsimith/Desktop/Summer Semester/Advanced Seminar/GBR/Factor_data.csv")

save(Factor_data, file = "/Users/kojimadamsimith/Desktop/Summer Semester/Advanced Seminar/GBR/Factor_data.RData")
  
```
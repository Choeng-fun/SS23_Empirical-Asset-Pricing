
library(data.table)
library(tidyr)
library(tidyverse)
library(rollRegres)
library(roll)
library(zoo)
library(dplyr)
library(vars)
library(mFilter)
library(tseries)
library(TSstudio)
library(forecast)
library(tidyverse)

load("~/Desktop/Empirical Asset Pricing/Repo/Univariate_Sort_Set.RData")



# B/Mm contains many NA value and will make the time series discontinuous, so we ignore this variable
# Remove the first 36 months for each stock because Alpha_3 is NA, 
VAR_5_Set <- Univariate_Sort_Set[!is.na(Alpha_3),c("Id","ym","RET.USD","Sigma_3", "CEI", "Log_MV", "Alpha_3", "RSI")]
VAR_3_Set <- Univariate_Sort_Set[!is.na(Alpha_3),c("Id","ym","RET.USD","Log_MV","Alpha_3","RSI")]


# Check if there is missing value and have many stocks have missing
VAR_3_Set[,check_NA_using_sum:=RET.USD+Log_MV+Alpha_3+RSI]
length(unique(VAR_3_Set[is.na(check_NA_using_sum),]$Id))
VAR_3_Set[,check_NA_using_sum:=NULL]
VAR_5_Set[,check_NA_using_sum:=RET.USD+Sigma_3+CEI+Log_MV+Alpha_3+RSI]
length(unique(VAR_5_Set[is.na(check_NA_using_sum),]$Id))
VAR_5_Set[,check_NA_using_sum:=NULL]

# filter out stocks that have a history less than 36 months
Stock_list_long_history <- as.list(VAR_3_Set[,.N, by=Id][N>=36]$Id)
VAR_3_Set <- VAR_3_Set[Id %in% Stock_list_long_history]
VAR_5_Set <- VAR_5_Set[Id %in% Stock_list_long_history]
Stock_list <- as.list(unique(VAR_3_Set$Id))

# Replace NA in log_MV as the minimum number -4.60517
VAR_3_Set[is.infinite(Log_MV), Log_MV := -4.60517]
VAR_5_Set[is.infinite(Log_MV), Log_MV := -4.60517]


# Function creation
VAR_Func <- function(stocks){

  VAR_3_Set_RETfcst <- data.table(
    col1 = integer(),
    col2 = character(),
    col3 = logical()
  )

  for (stock in stocks){
    
    n_pred_period <- nrow(VAR_3_Set[Id==stock,])-36
    Single_Stock_Set <- VAR_3_Set[Id==stock,]
    Single_Stock_36M_Set <- Single_Stock_Set[1:36]
    Single_Stock_Training_Set <- Single_Stock_36M_Set %>% mutate(Id=NULL) %>% mutate(ym=NULL)
    lag_order <- VARselect(Single_Stock_Training_Set, lag.max = 10, type = "both")$selection[1]
    VARModel <- VAR(Single_Stock_Training_Set, p = lag_order, type = "const", season = NULL, exog = NULL) 
    forecast <- predict(VARModel, n.ahead = n_pred_period, ci = 0.95)
    RET_VARfcst <- forecast$fcst$RET.USD
    RET_list <- as.list(RET_VARfcst[1:n_pred_period])
    RET_list <- c(rep(NA,36),RET_list)
    Single_Stock_Set$RET_VARfcst <- RET_list
    VAR_3_Set_RETfcst <- 
  }
}


VAR_Func(Stock_list)




example <- VAR_3_Set %>%  filter(Id=="134982") %>% slice(1:36) 
example <- example[,Id:=NULL]
example <- example[,ym:=NULL]

Model1 <- VAR(example, p = 6, type = "const", season = NULL, exog = NULL) 

forecast <- predict(Model1, n.ahead = 5, ci = 0.95)
fanchart(forecast, names = "RET.USD", main = "Fanchart for RET.USD", xlab = "Horizon", ylab = "Log_MV")
q <- forecast$fcst$RET.USD[1:5]

q

